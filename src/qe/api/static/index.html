<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Question Engine OS</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0a0c10; overflow: hidden; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #1e2330; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #2a3040; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
    button:hover { filter: brightness(1.1); }
    textarea::placeholder, input::placeholder { color: #5c6478; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const API = window.location.origin;
    const WS_URL = `ws://${window.location.host}/ws`;

    const FONT_MONO = "'IBM Plex Mono', 'Fira Code', 'SF Mono', monospace";
    const FONT_SANS = "'IBM Plex Sans', 'DM Sans', system-ui, sans-serif";

    const palette = {
      bg: "#0a0c10", surface: "#12151c", surfaceHover: "#181c26",
      border: "#1e2330", borderBright: "#2a3040",
      text: "#c8cdd8", textDim: "#5c6478", textBright: "#e8ecf4",
      accent: "#e09840", accentDim: "rgba(224,152,64,0.15)",
      green: "#3ddc84", greenDim: "rgba(61,220,132,0.12)",
      red: "#f44060", redDim: "rgba(244,64,96,0.12)",
      blue: "#4a9eff", blueDim: "rgba(74,158,255,0.10)",
      purple: "#a78bfa",
    };

    const Icon = ({ d, size = 16, color = palette.textDim, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ flexShrink: 0, ...style }}>
        <path d={d} />
      </svg>
    );

    const Icons = {
      dashboard: "M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z M9 22V12h6v10",
      submit: "M12 19V5 M5 12l7-7 7 7",
      claims: "M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2 M9 5a2 2 0 002 2h2a2 2 0 002-2 M9 5a2 2 0 012-2h2a2 2 0 012 2",
      ask: "M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3 M12 17h.01 M12 2a10 10 0 100 20 10 10 0 000-20z",
      entities: "M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2 M9 7a4 4 0 100-8 4 4 0 000 8z M23 21v-2a4 4 0 00-3-3.87 M16 3.13a4 4 0 010 7.75",
      hil: "M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2 M8.5 7a4 4 0 100-8 4 4 0 000 8z M20 8v6 M23 11h-6",
      chat: "M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2v10z",
      bus: "M22 12h-4l-3 9L9 3l-3 9H2",
      check: "M20 6L9 17l-5-5",
      x: "M18 6L6 18 M6 6l12 12",
      search: "M11 3a8 8 0 100 16 8 8 0 000-16z M21 21l-4.35-4.35",
      trash: "M3 6h18 M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2",
      alert: "M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z M12 9v4 M12 17h.01",
      system: "M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5",
      settings: "M12.22 2h-.44a2 2 0 00-2 2v.18a2 2 0 01-1 1.73l-.43.25a2 2 0 01-2 0l-.15-.08a2 2 0 00-2.73.73l-.22.38a2 2 0 00.73 2.73l.15.1a2 2 0 011 1.72v.51a2 2 0 01-1 1.74l-.15.09a2 2 0 00-.73 2.73l.22.38a2 2 0 002.73.73l.15-.08a2 2 0 012 0l.43.25a2 2 0 011 1.73V20a2 2 0 002 2h.44a2 2 0 002-2v-.18a2 2 0 011-1.73l.43-.25a2 2 0 012 0l.15.08a2 2 0 002.73-.73l.22-.39a2 2 0 00-.73-2.73l-.15-.08a2 2 0 01-1-1.74v-.5a2 2 0 011-1.74l.15-.09a2 2 0 00.73-2.73l-.22-.38a2 2 0 00-2.73-.73l-.15.08a2 2 0 01-2 0l-.43-.25a2 2 0 01-1-1.73V4a2 2 0 00-2-2z M12 8a4 4 0 100 8 4 4 0 000-8z",
    };

    const Badge = ({ children, color = palette.accent, bg }) => (
      <span style={{
        display: "inline-flex", alignItems: "center", gap: 4,
        padding: "2px 8px", borderRadius: 4, fontSize: 11, fontFamily: FONT_MONO,
        color, background: bg || `${color}18`, fontWeight: 600, letterSpacing: "0.02em",
        lineHeight: "18px", whiteSpace: "nowrap",
      }}>{children}</span>
    );

    const StatusDot = ({ alive }) => (
      <span style={{
        display: "inline-block", width: 8, height: 8, borderRadius: "50%",
        background: alive ? palette.green : palette.red, flexShrink: 0,
        boxShadow: alive ? `0 0 6px ${palette.green}80` : `0 0 6px ${palette.red}80`,
      }} />
    );

    const Stat = ({ label, value, sub, color = palette.textBright }) => (
      <div style={{ display: "flex", flexDirection: "column", gap: 2 }}>
        <span style={{ fontSize: 11, color: palette.textDim, fontFamily: FONT_MONO, textTransform: "uppercase", letterSpacing: "0.08em" }}>{label}</span>
        <span style={{ fontSize: 28, fontWeight: 700, fontFamily: FONT_MONO, color, lineHeight: 1 }}>{value}</span>
        {sub && <span style={{ fontSize: 11, color: palette.textDim, fontFamily: FONT_MONO }}>{sub}</span>}
      </div>
    );

    const EmptyState = ({ icon, message }) => (
      <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", padding: "48px 24px", gap: 12, opacity: 0.5 }}>
        <Icon d={icon} size={32} color={palette.textDim} />
        <span style={{ fontSize: 13, color: palette.textDim, fontFamily: FONT_MONO }}>{message}</span>
      </div>
    );

    function TopicBadge({ topic }) {
      const colors = {
        "observations": palette.blue, "claims": palette.purple,
        "hil": palette.accent, "system": palette.textDim,
        "investigations": palette.green, "queries": palette.blue,
        "entities": palette.green, "ingestion": palette.accent,
      };
      const prefix = topic.split(".")[0];
      const isContradiction = topic === "claims.contradiction_detected";
      return <Badge color={isContradiction ? palette.red : (colors[prefix] || palette.textDim)}>{topic}</Badge>;
    }

    function ConfidenceBar({ value }) {
      const pct = Math.round(value * 100);
      const color = value > 0.8 ? palette.green : value > 0.6 ? palette.accent : palette.red;
      return (
        <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
          <div style={{ width: 40, height: 4, background: palette.border, borderRadius: 2, overflow: "hidden" }}>
            <div style={{ width: `${pct}%`, height: "100%", background: color, borderRadius: 2 }} />
          </div>
          <span style={{ fontSize: 11, fontFamily: FONT_MONO, color }}>{pct}%</span>
        </div>
      );
    }

    // ── Chat Sub-Components ────────────────────────────────────────────────

    function InlineClaimCard({ claim }) {
      return (
        <div style={{
          padding: "8px 12px", borderLeft: `3px solid ${palette.blue}`,
          marginTop: 6, background: palette.bg, borderRadius: "0 4px 4px 0",
        }}>
          <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
            <Badge color={palette.blue}>{claim.subject_entity_id}</Badge>
            <span style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim }}>{claim.predicate}</span>
            <span style={{ fontSize: 12, color: palette.text, flex: 1 }}>{claim.object_value}</span>
            {claim.confidence != null && <ConfidenceBar value={claim.confidence} />}
          </div>
        </div>
      );
    }

    function PipelineProgress({ events, complete }) {
      const stages = [
        { label: "Submitted", done: true },
        { label: "Extracting", done: events.some(e => e.topic === "claims.proposed") },
        { label: "Committed", done: events.some(e => e.topic === "claims.committed") },
      ];
      return (
        <div style={{
          marginTop: 8, padding: "8px 12px", background: palette.bg,
          borderRadius: 6, border: `1px solid ${palette.border}`,
        }}>
          <div style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim, marginBottom: 6, textTransform: "uppercase" }}>
            Pipeline {complete ? "Complete" : "Processing..."}
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
            {stages.map((s, i) => (
              <React.Fragment key={i}>
                <div style={{
                  display: "flex", alignItems: "center", gap: 4,
                  color: s.done ? palette.green : palette.textDim,
                  fontSize: 11, fontFamily: FONT_MONO,
                }}>
                  {s.done
                    ? <Icon d={Icons.check} size={12} color={palette.green} />
                    : <span style={{ animation: "pulse 1.5s infinite" }}>...</span>
                  }
                  {s.label}
                </div>
                {i < stages.length - 1 && <span style={{ color: palette.textDim }}>{"\u2192"}</span>}
              </React.Fragment>
            ))}
          </div>
        </div>
      );
    }

    function ChatMessage({ msg, pipelineEvents, isLastMessage, onSuggestionClick }) {
      const isUser = msg.role === "user";
      const isSystem = msg.role === "system";
      return (
        <div style={{
          display: "flex", justifyContent: isUser ? "flex-end" : "flex-start",
          marginBottom: 12, animation: "fadeIn 0.3s ease",
        }}>
          <div style={{
            maxWidth: "75%", padding: "12px 16px",
            borderRadius: isUser ? "12px 12px 2px 12px" : "12px 12px 12px 2px",
            background: isUser ? palette.accentDim : isSystem ? palette.redDim : palette.surface,
            border: `1px solid ${isUser ? palette.accent + "40" : isSystem ? palette.red + "40" : palette.border}`,
          }}>
            {!isUser && (
              <div style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim, marginBottom: 4, textTransform: "uppercase", display: "flex", alignItems: "center", gap: 6 }}>
                {isSystem ? "System" : "QE Assistant"}
                {msg.intent && <Badge color={palette.blue}>{msg.intent}</Badge>}
              </div>
            )}
            <div style={{
              fontSize: 13, color: isUser ? palette.accent : palette.textBright,
              lineHeight: 1.6, whiteSpace: "pre-wrap",
            }}>{msg.content}</div>
            {msg.claims && msg.claims.length > 0 && (
              <div style={{ marginTop: 8 }}>
                <div style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim, marginBottom: 4 }}>
                  SUPPORTING CLAIMS ({msg.claims.length})
                </div>
                {msg.claims.map((c, i) => <InlineClaimCard key={c.claim_id || i} claim={c} />)}
              </div>
            )}
            {msg.confidence != null && (
              <div style={{ marginTop: 8, display: "flex", alignItems: "center", gap: 6 }}>
                <span style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim }}>Confidence:</span>
                <ConfidenceBar value={msg.confidence} />
              </div>
            )}
            {msg.entities && msg.entities.length > 0 && (
              <div style={{ marginTop: 8, display: "flex", flexWrap: "wrap", gap: 4 }}>
                {msg.entities.map(e => (
                  <Badge key={e.canonical_name} color={palette.green}>{e.canonical_name} ({e.claim_count || 0})</Badge>
                ))}
              </div>
            )}
            {msg.tracking_envelope_id && (
              <PipelineProgress
                events={pipelineEvents[msg.tracking_envelope_id] || []}
                complete={msg.pipeline_complete}
              />
            )}
            {msg.suggestions && msg.suggestions.length > 0 && isLastMessage && (
              <div style={{ marginTop: 10, display: "flex", flexWrap: "wrap", gap: 6 }}>
                {msg.suggestions.map((s, i) => (
                  <button key={i} onClick={() => onSuggestionClick && onSuggestionClick(s)}
                    style={{
                      padding: "5px 12px", borderRadius: 14, fontSize: 11,
                      fontFamily: FONT_MONO, cursor: "pointer",
                      border: `1px solid ${palette.accent}40`,
                      background: palette.accentDim, color: palette.accent,
                    }}>{s}</button>
                ))}
              </div>
            )}
            <div style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim, marginTop: 6, textAlign: isUser ? "right" : "left" }}>
              {new Date(msg.timestamp).toLocaleTimeString()}
            </div>
          </div>
        </div>
      );
    }

    // ── System Map Components ─────────────────────────────────────────────

    function PipelineFunnel({ events }) {
      const counts = {
        observations: events.filter(e => e.topic && e.topic.startsWith("observations.")).length,
        proposed: events.filter(e => e.topic === "claims.proposed").length,
        committed: events.filter(e => e.topic === "claims.committed").length,
      };
      const stages = [
        { label: "Observations", count: counts.observations, color: palette.blue },
        { label: "Proposed", count: counts.proposed, color: palette.purple },
        { label: "Committed", count: counts.committed, color: palette.green },
      ];
      return (
        <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 20 }}>
          {stages.map((s, i) => {
            const prev = i > 0 ? stages[i - 1].count : null;
            const pct = prev > 0 ? Math.round(s.count / prev * 100) : null;
            return (
              <React.Fragment key={s.label}>
                {i > 0 && (
                  <div style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: 2 }}>
                    <span style={{ fontSize: 16, color: palette.textDim }}>{"\u2192"}</span>
                    {pct != null && <span style={{ fontSize: 9, fontFamily: FONT_MONO, color: palette.textDim }}>{pct}%</span>}
                  </div>
                )}
                <div style={{
                  flex: 1, padding: "14px 18px",
                  background: palette.surface, border: `1px solid ${s.color}30`, borderRadius: 8,
                }}>
                  <div style={{ fontSize: 10, fontFamily: FONT_MONO, color: s.color, textTransform: "uppercase", letterSpacing: "0.06em", marginBottom: 6 }}>{s.label}</div>
                  <span style={{ fontSize: 28, fontWeight: 700, fontFamily: FONT_MONO, color: s.color, lineHeight: 1 }}>{s.count}</span>
                </div>
              </React.Fragment>
            );
          })}
        </div>
      );
    }

    function BudgetGauge({ budget }) {
      if (!budget) return null;
      const remaining = budget.remaining_pct || 0;
      const spent = budget.total_spend || 0;
      const limit = budget.limit_usd || 5;
      const usedPct = Math.min(100, Math.max(0, 100 - remaining));
      const color = remaining > 50 ? palette.green : remaining > 20 ? palette.accent : palette.red;
      const models = budget.by_model || {};
      return (
        <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: "16px 20px", marginTop: 16 }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 10 }}>
            <span style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, textTransform: "uppercase", letterSpacing: "0.06em" }}>Budget Usage</span>
            <span style={{ fontSize: 13, fontFamily: FONT_MONO, color }}>${spent.toFixed(4)} / ${limit.toFixed(2)}</span>
          </div>
          <div style={{ height: 8, background: palette.border, borderRadius: 4, overflow: "hidden", marginBottom: 12 }}>
            <div style={{ width: `${usedPct}%`, height: "100%", background: color, borderRadius: 4, transition: "width 0.5s ease" }} />
          </div>
          {Object.keys(models).length > 0 && (
            <div style={{ display: "flex", gap: 16, flexWrap: "wrap" }}>
              {Object.entries(models).map(([model, spend]) => (
                <div key={model} style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <div style={{ width: 8, height: 8, borderRadius: 2, background: palette.accent }} />
                  <span style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim }}>{model}</span>
                  <span style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.text }}>${(typeof spend === "number" ? spend : 0).toFixed(4)}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    function TopicActivity({ events }) {
      const topicCounts = {};
      events.forEach(e => { if (e.topic) topicCounts[e.topic] = (topicCounts[e.topic] || 0) + 1; });
      const sorted = Object.entries(topicCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);
      if (sorted.length === 0) return null;
      const max = sorted[0][1];
      return (
        <div style={{ marginTop: 16, background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: "16px 20px" }}>
          <div style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, textTransform: "uppercase", letterSpacing: "0.06em", marginBottom: 12 }}>Topic Activity</div>
          <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
            {sorted.map(([topic, count]) => (
              <div key={topic} style={{ display: "flex", alignItems: "center", gap: 10 }}>
                <div style={{ minWidth: 160 }}><TopicBadge topic={topic} /></div>
                <div style={{ flex: 1, height: 4, background: palette.border, borderRadius: 2, overflow: "hidden" }}>
                  <div style={{ width: `${(count / max) * 100}%`, height: "100%", background: palette.accent, borderRadius: 2, transition: "width 0.3s" }} />
                </div>
                <span style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim, minWidth: 28, textAlign: "right" }}>{count}</span>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function SystemMapGraph({ services, events }) {
      const containerRef = useRef(null);
      const netRef = useRef(null);
      const nodesDs = useRef(null);
      const edgesDs = useRef(null);
      const prevEventId = useRef(null);
      const svcKey = services.map(s => s.service_id).sort().join(",");

      useEffect(() => {
        if (!containerRef.current) return;
        const V = window.vis;
        if (!V || !V.Network) return;

        const nodes = new V.DataSet();
        const edges = new V.DataSet();
        nodesDs.current = nodes;
        edgesDs.current = edges;

        nodes.add({
          id: "_bus", label: "Memory\nBus", shape: "diamond", size: 30,
          color: { background: "#1a1510", border: palette.accent },
          font: { color: palette.accent, face: "IBM Plex Mono", size: 11, multi: true },
          fixed: { x: true, y: true }, x: 0, y: 0,
        });

        nodes.add({
          id: "_api", label: "API", shape: "triangleDown", size: 18,
          color: { background: "#0d1520", border: palette.blue },
          font: { color: palette.blue, face: "IBM Plex Mono", size: 11 },
        });
        edges.add({ id: "e__api", from: "_api", to: "_bus", color: { color: palette.blue + "50" }, width: 2, arrows: "to" });

        services.forEach(svc => {
          const alive = svc.status === "alive";
          const broken = svc.circuit_broken;
          const bc = broken ? palette.red : alive ? palette.green : palette.textDim;
          nodes.add({
            id: svc.service_id,
            label: (svc.display_name || svc.service_id).replace(/ /g, "\n"),
            shape: "dot", size: 16,
            color: { background: bc + "20", border: bc },
            font: { color: palette.text, face: "IBM Plex Mono", size: 10, multi: true },
            title: (svc.display_name || svc.service_id) + "\nStatus: " + svc.status + "\nTurns: " + svc.turn_count + (broken ? "\nCIRCUIT BROKEN" : ""),
          });
          edges.add({
            id: "e_" + svc.service_id, from: "_bus", to: svc.service_id,
            color: { color: palette.border }, width: 1.5, arrows: "to",
          });
        });

        const net = new V.Network(containerRef.current, { nodes, edges }, {
          physics: {
            barnesHut: { gravitationalConstant: -3000, centralGravity: 0.3, springLength: 140, springConstant: 0.04 },
            stabilization: { iterations: 80 },
          },
          interaction: { hover: true, tooltipDelay: 150, zoomView: true, dragView: true },
          nodes: { borderWidth: 2, shadow: { enabled: true, color: "rgba(0,0,0,0.3)", size: 5 } },
          edges: { smooth: { type: "continuous" } },
        });
        netRef.current = net;
        return () => { net.destroy(); netRef.current = null; nodesDs.current = null; edgesDs.current = null; };
      }, [svcKey]);

      useEffect(() => {
        const ds = nodesDs.current;
        if (!ds) return;
        services.forEach(svc => {
          try {
            const alive = svc.status === "alive";
            const broken = svc.circuit_broken;
            const bc = broken ? palette.red : alive ? palette.green : palette.textDim;
            ds.update({ id: svc.service_id, color: { background: bc + "20", border: bc } });
          } catch (e) {}
        });
      }, [services]);

      useEffect(() => {
        const nds = nodesDs.current;
        const eds = edgesDs.current;
        if (!nds || !eds || events.length === 0) return;
        const latest = events[0];
        if (!latest || latest.envelope_id === prevEventId.current) return;
        prevEventId.current = latest.envelope_id;

        const sid = latest.source_service_id;
        const eid = "e_" + sid;
        try { eds.update({ id: eid, color: { color: palette.accent }, width: 3 }); } catch (e) {}
        try { nds.update({ id: sid, size: 22, borderWidth: 3 }); } catch (e) {}

        setTimeout(() => {
          try { eds.update({ id: eid, color: { color: palette.border }, width: 1.5 }); } catch (e) {}
          try { nds.update({ id: sid, size: 16, borderWidth: 2 }); } catch (e) {}
        }, 700);
      }, [events]);

      if (typeof window.vis === "undefined") {
        return (
          <div style={{ height: 380, display: "flex", alignItems: "center", justifyContent: "center", background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, marginBottom: 16 }}>
            <span style={{ fontSize: 12, fontFamily: FONT_MONO, color: palette.textDim }}>Loading visualization library...</span>
          </div>
        );
      }

      return <div ref={containerRef} style={{ height: 380, background: "#0e1018", border: `1px solid ${palette.border}`, borderRadius: 8, marginBottom: 16 }} />;
    }

    // ── Setup Screen ──────────────────────────────────────────────────────
    function SetupScreen({ onComplete }) {
      const [providers, setProviders] = useState([]);
      const [tierConfig, setTierConfig] = useState({
        fast:     { provider: "", model: "" },
        balanced: { provider: "", model: "" },
        powerful: { provider: "", model: "" },
      });
      const [apiKeys, setApiKeys] = useState({});
      const [saving, setSaving] = useState(false);
      const [error, setError] = useState(null);
      const [ollamaEnabled, setOllamaEnabled] = useState(false);

      useEffect(() => {
        fetch(`${API}/api/setup/providers`).then(r => r.json()).then(data => {
          setProviders(data.providers || []);
        }).catch(() => {});
        // Pre-fill from existing status
        fetch(`${API}/api/setup/status`).then(r => r.json()).then(data => {
          if (data.tiers) {
            const tiers = {};
            for (const [tier, model] of Object.entries(data.tiers)) {
              // Try to detect provider from model name
              const prov = detectProvider(model, data.providers || []);
              tiers[tier] = { provider: prov, model };
            }
            setTierConfig(prev => ({ ...prev, ...tiers }));
          }
        }).catch(() => {});
      }, []);

      const detectProvider = (model, provList) => {
        if (!model) return "";
        if (model.startsWith("ollama/")) return "Ollama (local)";
        if (model.startsWith("groq/")) return "Groq";
        if (model.startsWith("mistral/")) return "Mistral";
        if (model.startsWith("gemini/")) return "Google Gemini";
        if (model.startsWith("together_ai/")) return "Together AI";
        if (model.startsWith("openrouter/")) return "OpenRouter";
        if (model.startsWith("claude")) return "Anthropic";
        return "OpenAI";
      };

      const getProviderByName = (name) => providers.find(p => p.name === name);

      const handleProviderChange = (tier, providerName) => {
        const prov = getProviderByName(providerName);
        const model = prov ? (prov.tier_defaults[tier] || prov.example_models[0]) : "";
        setTierConfig(prev => ({ ...prev, [tier]: { provider: providerName, model } }));
        if (providerName === "Ollama (local)") setOllamaEnabled(true);
      };

      const handleModelChange = (tier, model) => {
        setTierConfig(prev => ({ ...prev, [tier]: { ...prev[tier], model } }));
      };

      const handleKeyChange = (envVar, value) => {
        setApiKeys(prev => ({ ...prev, [envVar]: value }));
      };

      // Collect unique providers that need keys
      const neededKeys = {};
      Object.values(tierConfig).forEach(tc => {
        const prov = getProviderByName(tc.provider);
        if (prov && prov.env_var && !neededKeys[prov.env_var]) {
          neededKeys[prov.env_var] = prov.name;
        }
      });

      const handleSave = async () => {
        setSaving(true);
        setError(null);
        try {
          const res = await fetch(`${API}/api/setup/save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ providers: apiKeys, tiers: tierConfig }),
          });
          const data = await res.json();
          if (!res.ok) { setError(data.error || "Save failed"); setSaving(false); return; }
          if (data.complete) {
            onComplete();
          } else {
            setError("Setup saved but no valid API key detected. Please enter at least one API key.");
            setSaving(false);
          }
        } catch (e) {
          setError("Network error");
          setSaving(false);
        }
      };

      const tierLabels = {
        fast: { label: "Fast", desc: "Quick responses, lower cost", color: palette.green },
        balanced: { label: "Balanced", desc: "Good quality / cost tradeoff", color: palette.blue },
        powerful: { label: "Powerful", desc: "Best quality, higher cost", color: palette.purple },
      };

      return (
        <div style={{
          minHeight: "100vh", background: palette.bg, display: "flex",
          alignItems: "center", justifyContent: "center", fontFamily: FONT_SANS, padding: 20,
          overflow: "auto",
        }}>
          <div style={{
            width: "100%", maxWidth: 720, background: palette.surface,
            border: `1px solid ${palette.border}`, borderRadius: 12, padding: "40px 36px",
          }}>
            {/* Header */}
            <div style={{ display: "flex", alignItems: "center", gap: 14, marginBottom: 8 }}>
              <div style={{
                width: 44, height: 44, borderRadius: 8, background: palette.accentDim,
                display: "flex", alignItems: "center", justifyContent: "center",
                border: `1px solid ${palette.accent}40`, fontSize: 18, fontFamily: FONT_MONO,
                color: palette.accent, fontWeight: 800,
              }}>QE</div>
              <div>
                <div style={{ fontSize: 20, fontWeight: 700, color: palette.textBright }}>Welcome to Question Engine</div>
                <div style={{ fontSize: 13, color: palette.textDim, fontFamily: FONT_MONO }}>Configure your LLM providers to get started</div>
              </div>
            </div>

            <div style={{ height: 1, background: palette.border, margin: "24px 0" }} />

            {/* Tier Cards */}
            <div style={{ display: "flex", flexDirection: "column", gap: 20, marginBottom: 28 }}>
              {["fast", "balanced", "powerful"].map(tier => {
                const tc = tierConfig[tier];
                const info = tierLabels[tier];
                return (
                  <div key={tier} style={{
                    background: palette.bg, border: `1px solid ${palette.border}`,
                    borderRadius: 8, padding: "18px 20px",
                  }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 14 }}>
                      <span style={{
                        display: "inline-block", width: 10, height: 10, borderRadius: "50%",
                        background: info.color,
                      }} />
                      <span style={{ fontSize: 15, fontWeight: 700, color: palette.textBright }}>{info.label}</span>
                      <span style={{ fontSize: 12, color: palette.textDim, fontFamily: FONT_MONO }}>{info.desc}</span>
                    </div>
                    <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
                      <div style={{ flex: 1, minWidth: 180 }}>
                        <label style={{ fontSize: 11, color: palette.textDim, fontFamily: FONT_MONO, textTransform: "uppercase", letterSpacing: "0.06em", display: "block", marginBottom: 6 }}>Provider</label>
                        <select
                          value={tc.provider}
                          onChange={e => handleProviderChange(tier, e.target.value)}
                          style={{
                            width: "100%", padding: "8px 10px", borderRadius: 5,
                            border: `1px solid ${palette.border}`, background: palette.surface,
                            color: palette.text, fontFamily: FONT_MONO, fontSize: 13, outline: "none",
                          }}
                        >
                          <option value="">Select provider...</option>
                          {providers.map(p => (
                            <option key={p.name} value={p.name}>{p.name}</option>
                          ))}
                        </select>
                      </div>
                      <div style={{ flex: 1, minWidth: 220 }}>
                        <label style={{ fontSize: 11, color: palette.textDim, fontFamily: FONT_MONO, textTransform: "uppercase", letterSpacing: "0.06em", display: "block", marginBottom: 6 }}>Model</label>
                        <input
                          type="text"
                          value={tc.model}
                          onChange={e => handleModelChange(tier, e.target.value)}
                          placeholder="e.g. gpt-4o-mini"
                          style={{
                            width: "100%", padding: "8px 10px", borderRadius: 5,
                            border: `1px solid ${palette.border}`, background: palette.surface,
                            color: palette.text, fontFamily: FONT_MONO, fontSize: 13, outline: "none",
                          }}
                        />
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* API Keys */}
            {Object.keys(neededKeys).length > 0 && (
              <div style={{ marginBottom: 28 }}>
                <div style={{ fontSize: 14, fontWeight: 600, color: palette.textBright, marginBottom: 14 }}>API Keys</div>
                <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
                  {Object.entries(neededKeys).map(([envVar, provName]) => (
                    <div key={envVar} style={{
                      background: palette.bg, border: `1px solid ${palette.border}`,
                      borderRadius: 8, padding: "14px 18px",
                    }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}>
                        <span style={{ fontSize: 13, fontWeight: 600, color: palette.text }}>{provName}</span>
                        <span style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim }}>{envVar}</span>
                      </div>
                      <input
                        type="password"
                        value={apiKeys[envVar] || ""}
                        onChange={e => handleKeyChange(envVar, e.target.value)}
                        placeholder={`Enter ${envVar}...`}
                        style={{
                          width: "100%", padding: "8px 10px", borderRadius: 5,
                          border: `1px solid ${palette.border}`, background: palette.surface,
                          color: palette.text, fontFamily: FONT_MONO, fontSize: 13, outline: "none",
                        }}
                      />
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Ollama toggle */}
            <div style={{
              background: palette.bg, border: `1px solid ${palette.border}`,
              borderRadius: 8, padding: "14px 18px", marginBottom: 28,
              display: "flex", alignItems: "center", gap: 12,
            }}>
              <div style={{
                width: 38, height: 22, borderRadius: 11, cursor: "pointer",
                background: ollamaEnabled ? palette.green : palette.border,
                transition: "background 0.2s", position: "relative",
              }} onClick={() => {
                const next = !ollamaEnabled;
                setOllamaEnabled(next);
                if (next) {
                  // Auto-set any empty tiers to Ollama
                  setTierConfig(prev => {
                    const updated = { ...prev };
                    for (const t of ["fast", "balanced", "powerful"]) {
                      if (!updated[t].provider) {
                        const ollamaP = getProviderByName("Ollama (local)");
                        updated[t] = { provider: "Ollama (local)", model: ollamaP ? ollamaP.tier_defaults[t] : "ollama/llama3.2" };
                      }
                    }
                    return updated;
                  });
                }
              }}>
                <div style={{
                  width: 18, height: 18, borderRadius: "50%", background: "#fff",
                  position: "absolute", top: 2,
                  left: ollamaEnabled ? 18 : 2,
                  transition: "left 0.2s",
                }} />
              </div>
              <div>
                <div style={{ fontSize: 13, fontWeight: 600, color: palette.text }}>Ollama (local models)</div>
                <div style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim }}>No API key needed — runs on your machine</div>
              </div>
            </div>

            {/* Error */}
            {error && (
              <div style={{
                background: palette.redDim, border: `1px solid ${palette.red}40`,
                borderRadius: 6, padding: "10px 14px", marginBottom: 16,
                fontSize: 13, color: palette.red, fontFamily: FONT_MONO,
              }}>{error}</div>
            )}

            {/* Start Button */}
            <button
              onClick={handleSave}
              disabled={saving}
              style={{
                width: "100%", padding: "14px 20px", borderRadius: 8, border: "none",
                cursor: saving ? "default" : "pointer",
                background: saving ? palette.border : `linear-gradient(135deg, ${palette.accent}, #c47e2a)`,
                color: saving ? palette.textDim : "#fff",
                fontFamily: FONT_MONO, fontSize: 15, fontWeight: 700,
                letterSpacing: "0.02em", transition: "all 0.2s",
              }}
            >{saving ? "Saving..." : "Start Engine"}</button>
          </div>
        </div>
      );
    }

    function App() {
      const [activeTab, setActiveTab] = useState("dashboard");
      const [claims, setClaims] = useState([]);
      const [events, setEvents] = useState([]);
      const [hilQueue, setHilQueue] = useState([]);
      const [services, setServices] = useState([]);
      const [entities, setEntities] = useState([]);
      const [engineRunning, setEngineRunning] = useState(false);
      const [budget, setBudget] = useState(null);
      const [observationText, setObservationText] = useState("");
      const [submitting, setSubmitting] = useState(false);
      const [searchQuery, setSearchQuery] = useState("");
      const [question, setQuestion] = useState("");
      const [asking, setAsking] = useState(false);
      const [answer, setAnswer] = useState(null);
      const [contradictions, setContradictions] = useState([]);
      const wsRef = useRef(null);

      // Chat state
      const [chatMessages, setChatMessages] = useState([]);
      const [chatInput, setChatInput] = useState("");
      const [chatTyping, setChatTyping] = useState(false);
      const [chatSessionId, setChatSessionId] = useState(null);
      const [chatPipelineEvents, setChatPipelineEvents] = useState({});
      const chatWsRef = useRef(null);
      const chatEndRef = useRef(null);

      // Settings state
      const [settings, setSettings] = useState({ budget: { monthly_limit_usd: 50, alert_at_pct: 0.80 }, runtime: { log_level: "INFO", hil_timeout_seconds: 3600 } });
      const [settingsDirty, setSettingsDirty] = useState(false);
      const [settingsSaving, setSettingsSaving] = useState(false);
      const [settingsError, setSettingsError] = useState(null);
      const [settingsSuccess, setSettingsSuccess] = useState(false);
      const [displayPrefs, setDisplayPrefs] = useState(() => {
        try {
          const saved = localStorage.getItem("qe_display_prefs");
          return saved ? JSON.parse(saved) : {
            eventFilters: ["observations", "claims", "goals", "tasks", "hil", "system", "chat", "channels", "inference", "entities", "queries", "ingestion", "analysis", "synthesis", "memory", "monitor", "notification", "voice", "document", "predictions"],
            minConfidence: 0,
            showSuperseded: false,
            timeRange: "all",
          };
        } catch { return { eventFilters: [], minConfidence: 0, showSuperseded: false, timeRange: "all" }; }
      });

      // Connect WebSocket
      useEffect(() => {
        const connect = () => {
          const ws = new WebSocket(WS_URL);
          ws.onopen = () => console.log("WebSocket connected");
          ws.onmessage = (msg) => {
            try {
              const data = JSON.parse(msg.data);
              if (data.type === "bus_event") {
                setEvents(prev => [{
                  envelope_id: data.envelope_id,
                  topic: data.topic,
                  source_service_id: data.source_service_id,
                  timestamp: data.timestamp,
                  payload: typeof data.payload === "string" ? data.payload : JSON.stringify(data.payload).slice(0, 120),
                }, ...prev].slice(0, 200));

                if (data.topic === "claims.committed") fetchClaims();
                if (data.topic === "hil.approval_required") fetchHil();
                if (data.topic === "claims.contradiction_detected") {
                  setContradictions(prev => [data.payload, ...prev].slice(0, 50));
                }
              }
            } catch {}
          };
          ws.onclose = () => setTimeout(connect, 2000);
          wsRef.current = ws;
        };
        connect();
        return () => { if (wsRef.current) wsRef.current.close(); };
      }, []);

      // Poll status
      useEffect(() => {
        const poll = async () => {
          try {
            const res = await fetch(`${API}/api/status`);
            if (res.ok) {
              const data = await res.json();
              setServices(data.services || []);
              setBudget(data.budget || null);
              setEngineRunning(data.services?.some(s => s.status === "alive") || false);
            }
          } catch {}
        };
        poll();
        const interval = setInterval(poll, 5000);
        return () => clearInterval(interval);
      }, []);

      const fetchClaims = async () => {
        try {
          const qs = displayPrefs.showSuperseded ? "?include_superseded=true" : "";
          const res = await fetch(`${API}/api/claims${qs}`);
          if (res.ok) { setClaims((await res.json()).claims || []); }
        } catch {}
      };

      const fetchHil = async () => {
        try {
          const res = await fetch(`${API}/api/hil/pending`);
          if (res.ok) { setHilQueue((await res.json()).pending || []); }
        } catch {}
      };

      const fetchEntities = async () => {
        try {
          const res = await fetch(`${API}/api/entities`);
          if (res.ok) { setEntities((await res.json()).entities || []); }
        } catch {}
      };

      useEffect(() => { fetchClaims(); fetchHil(); fetchEntities(); }, []);

      // Fetch settings on mount
      useEffect(() => {
        fetch(`${API}/api/settings`).then(r => r.json()).then(data => {
          if (data.budget || data.runtime) setSettings(data);
        }).catch(() => {});
      }, []);

      // Persist displayPrefs to localStorage
      useEffect(() => {
        try { localStorage.setItem("qe_display_prefs", JSON.stringify(displayPrefs)); } catch {}
      }, [displayPrefs]);

      const updateSetting = (section, key, value) => {
        setSettings(prev => ({ ...prev, [section]: { ...prev[section], [key]: value } }));
        setSettingsDirty(true);
      };

      const handleSettingsSave = async () => {
        setSettingsSaving(true);
        setSettingsError(null);
        try {
          const res = await fetch(`${API}/api/settings`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify(settings),
          });
          if (!res.ok) { const d = await res.json(); setSettingsError(d.error || "Save failed"); }
          else { setSettingsSuccess(true); setSettingsDirty(false); setTimeout(() => setSettingsSuccess(false), 3000); }
        } catch { setSettingsError("Network error"); }
        setSettingsSaving(false);
      };

      const handleResetCircuit = async (serviceId) => {
        try {
          await fetch(`${API}/api/services/${serviceId}/reset-circuit`, { method: "POST" });
        } catch {}
      };

      const toggleEventFilter = (group) => {
        setDisplayPrefs(prev => {
          const filters = prev.eventFilters || [];
          const next = filters.includes(group) ? filters.filter(f => f !== group) : [...filters, group];
          return { ...prev, eventFilters: next };
        });
      };

      // Chat WebSocket
      useEffect(() => {
        if (activeTab !== "chat") return;
        if (chatWsRef.current) return;

        const chatWs = new WebSocket(`ws://${window.location.host}/ws/chat`);
        chatWs.onopen = () => console.log("Chat WS connected");
        chatWs.onmessage = (msg) => {
          try {
            const data = JSON.parse(msg.data);
            if (data.type === "session_init") setChatSessionId(data.session_id);
            if (data.type === "typing") setChatTyping(data.active);
            if (data.type === "chat_response") {
              setChatMessages(prev => [...prev, {
                id: data.message_id, role: "assistant", content: data.reply_text,
                intent: data.intent, claims: data.claims || [], entities: data.entities || [],
                confidence: data.confidence, reasoning: data.reasoning,
                pipeline_complete: data.pipeline_complete,
                tracking_envelope_id: data.tracking_envelope_id,
                suggestions: data.suggestions || [],
                timestamp: new Date().toISOString(),
              }]);
              setChatTyping(false);
              if (data.tracking_envelope_id) {
                chatWs.send(JSON.stringify({ type: "track_envelope", envelope_id: data.tracking_envelope_id }));
              }
            }
            if (data.type === "pipeline_event") {
              setChatPipelineEvents(prev => {
                const key = data.correlation_id;
                const events = prev[key] || [];
                return { ...prev, [key]: [...events, data] };
              });
              if (data.topic === "claims.committed") {
                setChatMessages(prev => prev.map(m =>
                  m.tracking_envelope_id === data.correlation_id ? { ...m, pipeline_complete: true } : m
                ));
              }
            }
            if (data.type === "error") {
              setChatMessages(prev => [...prev, {
                id: `err_${Date.now()}`, role: "system", content: data.error,
                timestamp: new Date().toISOString(),
              }]);
            }
          } catch {}
        };
        chatWs.onclose = () => { chatWsRef.current = null; };
        chatWsRef.current = chatWs;
        return () => { if (chatWsRef.current) { chatWsRef.current.close(); chatWsRef.current = null; } };
      }, [activeTab]);

      // Auto-scroll chat
      useEffect(() => {
        if (chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: "smooth" });
      }, [chatMessages, chatTyping]);

      const handleChatSend = () => {
        if (!chatInput.trim() || !chatWsRef.current) return;
        const text = chatInput.trim();
        setChatMessages(prev => [...prev, {
          id: `user_${Date.now()}`, role: "user", content: text,
          timestamp: new Date().toISOString(),
        }]);
        setChatInput("");
        chatWsRef.current.send(JSON.stringify({ type: "message", content: text }));
      };

      const handleSubmit = async () => {
        if (!observationText.trim()) return;
        setSubmitting(true);
        try {
          const res = await fetch(`${API}/api/submit`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: observationText.trim() }),
          });
          if (res.ok) { setObservationText(""); setTimeout(fetchClaims, 3000); }
        } catch {}
        setSubmitting(false);
      };

      const handleAsk = async () => {
        if (!question.trim()) return;
        setAsking(true);
        setAnswer(null);
        try {
          const res = await fetch(`${API}/api/ask`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: question.trim() }),
          });
          if (res.ok) { setAnswer(await res.json()); }
        } catch {}
        setAsking(false);
      };

      const handleRetract = async (claimId) => {
        if (!confirm("Retract this claim?")) return;
        try {
          await fetch(`${API}/api/claims/${claimId}`, { method: "DELETE" });
          fetchClaims();
        } catch {}
      };

      const handleHilDecision = async (id, decision) => {
        try {
          await fetch(`${API}/api/hil/${id}/${decision}`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reason: "user decision" }),
          });
          fetchHil();
        } catch {}
      };

      const filteredClaims = claims.filter(c => {
        // Search filter
        if (searchQuery) {
          const q = searchQuery.toLowerCase();
          if (!(c.subject_entity_id || "").toLowerCase().includes(q) &&
              !(c.object_value || "").toLowerCase().includes(q) &&
              !(c.claim_id || "").includes(q)) return false;
        }
        // Min confidence filter
        if (displayPrefs.minConfidence > 0 && (c.confidence || 0) < displayPrefs.minConfidence / 100) return false;
        // Time range filter
        if (displayPrefs.timeRange && displayPrefs.timeRange !== "all" && c.created_at) {
          const cutoffs = { "1h": 3600000, "24h": 86400000, "7d": 604800000 };
          const cutoff = cutoffs[displayPrefs.timeRange];
          if (cutoff && (Date.now() - new Date(c.created_at).getTime()) > cutoff) return false;
        }
        return true;
      });

      const pendingHil = hilQueue.filter(h => h.status === "pending").length;

      const navItems = [
        { id: "dashboard", label: "Dashboard", icon: Icons.dashboard },
        { id: "system", label: "System Map", icon: Icons.system },
        { id: "chat", label: "Chat", icon: Icons.chat },
        { id: "ask", label: "Ask", icon: Icons.ask },
        { id: "submit", label: "Submit", icon: Icons.submit },
        { id: "claims", label: "Claims", icon: Icons.claims, count: claims.length },
        { id: "entities", label: "Entities", icon: Icons.entities, count: entities.length },
        { id: "hil", label: "HIL Queue", icon: Icons.hil, count: pendingHil },
        { id: "bus", label: "Event Bus", icon: Icons.bus, count: events.length },
        { id: "settings", label: "Settings", icon: Icons.settings },
      ];

      return (
        <div style={{
          display: "flex", height: "100vh", width: "100%", background: palette.bg,
          fontFamily: FONT_SANS, color: palette.text, overflow: "hidden",
        }}>
          {/* Sidebar */}
          <nav style={{
            width: 220, minWidth: 220, background: palette.surface,
            borderRight: `1px solid ${palette.border}`,
            display: "flex", flexDirection: "column",
          }}>
            <div style={{ padding: "20px 16px 16px", borderBottom: `1px solid ${palette.border}`, display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{
                width: 32, height: 32, borderRadius: 6, background: palette.accentDim,
                display: "flex", alignItems: "center", justifyContent: "center",
                border: `1px solid ${palette.accent}40`, fontSize: 14, fontFamily: FONT_MONO,
                color: palette.accent, fontWeight: 800,
              }}>QE</div>
              <div>
                <div style={{ fontSize: 13, fontWeight: 700, color: palette.textBright }}>Question Engine</div>
                <div style={{ fontSize: 10, color: palette.textDim, fontFamily: FONT_MONO }}>v0.2.0</div>
              </div>
            </div>

            <div style={{ padding: "12px 16px", borderBottom: `1px solid ${palette.border}` }}>
              <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10 }}>
                <StatusDot alive={engineRunning} />
                <span style={{ fontSize: 11, fontFamily: FONT_MONO, color: engineRunning ? palette.green : palette.textDim }}>
                  {engineRunning ? "ENGINE ONLINE" : "ENGINE OFFLINE"}
                </span>
              </div>
              {budget && (
                <div style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim }}>
                  Budget: ${budget.total_spend?.toFixed(4)} / ${budget.limit_usd?.toFixed(2)}
                </div>
              )}
            </div>

            <div style={{ padding: "8px 8px", flex: 1 }}>
              {navItems.map(item => {
                const active = activeTab === item.id;
                return (
                  <button key={item.id} onClick={() => setActiveTab(item.id)} style={{
                    display: "flex", alignItems: "center", gap: 10, width: "100%",
                    padding: "9px 10px", borderRadius: 6, border: "none", cursor: "pointer",
                    background: active ? palette.accentDim : "transparent",
                    color: active ? palette.accent : palette.textDim,
                    fontFamily: FONT_SANS, fontSize: 13, fontWeight: active ? 600 : 400,
                    marginBottom: 2, textAlign: "left",
                  }}>
                    <Icon d={item.icon} size={16} color={active ? palette.accent : palette.textDim} />
                    <span style={{ flex: 1 }}>{item.label}</span>
                    {item.count > 0 && (
                      <span style={{
                        fontSize: 10, fontFamily: FONT_MONO, padding: "1px 6px", borderRadius: 10,
                        background: active ? `${palette.accent}30` : palette.border,
                        color: active ? palette.accent : palette.textDim,
                      }}>{item.count}</span>
                    )}
                  </button>
                );
              })}
            </div>

            {contradictions.length > 0 && (
              <div style={{ padding: "8px 12px", borderTop: `1px solid ${palette.border}`, background: palette.redDim }}>
                <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 4 }}>
                  <Icon d={Icons.alert} size={14} color={palette.red} />
                  <span style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.red, fontWeight: 600 }}>CONTRADICTIONS ({contradictions.length})</span>
                </div>
                <span style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.red }}>
                  {contradictions[0]?.subject} / {contradictions[0]?.predicate}
                </span>
              </div>
            )}

            <div style={{ padding: "12px 16px", borderTop: `1px solid ${palette.border}` }}>
              <div style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim, marginBottom: 8, textTransform: "uppercase", letterSpacing: "0.08em" }}>Services</div>
              {services.map(s => (
                <div key={s.service_id} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                  <StatusDot alive={s.status === "alive"} />
                  <span style={{ fontSize: 11, color: palette.text, flex: 1 }}>{s.display_name || s.service_id}</span>
                  <span style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim }}>t{s.turn_count || 0}</span>
                </div>
              ))}
              {services.length === 0 && (
                <span style={{ fontSize: 11, color: palette.textDim, fontFamily: FONT_MONO }}>No services</span>
              )}
            </div>
          </nav>

          {/* Main content */}
          <main style={{ flex: 1, overflow: "auto", padding: "24px 32px" }}>

            {/* DASHBOARD */}
            {activeTab === "dashboard" && (
              <div>
                <h1 style={{ fontSize: 22, fontWeight: 700, color: palette.textBright, marginBottom: 4 }}>Dashboard</h1>
                <p style={{ fontSize: 13, color: palette.textDim, marginBottom: 24, fontFamily: FONT_MONO }}>System overview</p>
                <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 16, marginBottom: 28 }}>
                  {[
                    { label: "Claims", value: claims.length, color: palette.blue },
                    { label: "Entities", value: entities.length, color: palette.green },
                    { label: "Events", value: events.length, color: palette.purple },
                    { label: "Services", value: services.filter(s => s.status === "alive").length, sub: engineRunning ? "online" : "offline", color: engineRunning ? palette.green : palette.textDim },
                  ].map((s, i) => (
                    <div key={i} style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: "20px 20px" }}>
                      <Stat {...s} />
                    </div>
                  ))}
                </div>

                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, overflow: "hidden" }}>
                    <div style={{ padding: "14px 18px", borderBottom: `1px solid ${palette.border}`, display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                      <span style={{ fontSize: 13, fontWeight: 600, color: palette.textBright }}>Recent Claims</span>
                      {claims.length > 0 && <button onClick={() => setActiveTab("claims")} style={{ fontSize: 11, color: palette.accent, background: "none", border: "none", cursor: "pointer", fontFamily: FONT_MONO }}>View all</button>}
                    </div>
                    {claims.length === 0 ? <EmptyState icon={Icons.claims} message="No claims yet." /> : (
                      <div style={{ maxHeight: 320, overflow: "auto" }}>
                        {claims.slice(0, 8).map(c => (
                          <div key={c.claim_id} style={{ padding: "10px 18px", borderBottom: `1px solid ${palette.border}`, display: "flex", alignItems: "center", gap: 12 }}>
                            <Badge color={palette.blue}>{c.subject_entity_id}</Badge>
                            <span style={{ fontSize: 12, color: palette.textDim, fontFamily: FONT_MONO, flex: 1, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                              {c.predicate} - {c.object_value}
                            </span>
                            <span style={{ fontSize: 11, fontFamily: FONT_MONO, color: c.confidence > 0.8 ? palette.green : palette.accent }}>{(c.confidence * 100).toFixed(0)}%</span>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, overflow: "hidden" }}>
                    <div style={{ padding: "14px 18px", borderBottom: `1px solid ${palette.border}`, display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                      <span style={{ fontSize: 13, fontWeight: 600, color: palette.textBright }}>Event Bus</span>
                      {events.length > 0 && <button onClick={() => setActiveTab("bus")} style={{ fontSize: 11, color: palette.accent, background: "none", border: "none", cursor: "pointer", fontFamily: FONT_MONO }}>View all</button>}
                    </div>
                    {events.length === 0 ? <EmptyState icon={Icons.bus} message="No events yet." /> : (
                      <div style={{ maxHeight: 320, overflow: "auto" }}>
                        {events.slice(0, 10).map(e => (
                          <div key={e.envelope_id} style={{ padding: "8px 18px", borderBottom: `1px solid ${palette.border}`, display: "flex", alignItems: "center", gap: 10 }}>
                            <TopicBadge topic={e.topic} />
                            <span style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, flex: 1, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{e.payload}</span>
                            <span style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim }}>{new Date(e.timestamp).toLocaleTimeString()}</span>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* SYSTEM MAP */}
            {activeTab === "system" && (
              <div>
                <h1 style={{ fontSize: 22, fontWeight: 700, color: palette.textBright, marginBottom: 4 }}>System Map</h1>
                <p style={{ fontSize: 13, color: palette.textDim, marginBottom: 20, fontFamily: FONT_MONO }}>Live topology, pipeline metrics, and budget</p>

                <PipelineFunnel events={events} />

                {services.length > 0 ? (
                  <SystemMapGraph services={services} events={events} />
                ) : (
                  <div style={{ height: 380, background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, marginBottom: 16, display: "flex", alignItems: "center", justifyContent: "center" }}>
                    <EmptyState icon={Icons.system} message="No services running. Start the engine to see topology." />
                  </div>
                )}

                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
                  <div>
                    <BudgetGauge budget={budget} />
                  </div>
                  <div>
                    <TopicActivity events={events} />
                  </div>
                </div>
              </div>
            )}

            {/* ASK */}
            {activeTab === "ask" && (
              <div>
                <h1 style={{ fontSize: 22, fontWeight: 700, color: palette.textBright, marginBottom: 4 }}>Ask a Question</h1>
                <p style={{ fontSize: 13, color: palette.textDim, marginBottom: 28, fontFamily: FONT_MONO }}>Query the belief ledger with natural language</p>
                <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: 24, maxWidth: 720 }}>
                  <div style={{ display: "flex", gap: 10, marginBottom: 16 }}>
                    <input
                      value={question}
                      onChange={e => setQuestion(e.target.value)}
                      onKeyDown={e => e.key === "Enter" && handleAsk()}
                      placeholder="What do you want to know?"
                      style={{
                        flex: 1, padding: "12px 14px", borderRadius: 6,
                        background: palette.bg, border: `1px solid ${palette.border}`, color: palette.text,
                        fontFamily: FONT_MONO, fontSize: 13, outline: "none",
                      }}
                    />
                    <button onClick={handleAsk} disabled={!question.trim() || asking} style={{
                      padding: "10px 24px", borderRadius: 6, border: "none", cursor: question.trim() && !asking ? "pointer" : "not-allowed",
                      fontFamily: FONT_MONO, fontSize: 12, fontWeight: 600,
                      background: palette.accent, color: palette.bg,
                      opacity: !question.trim() || asking ? 0.5 : 1,
                    }}>{asking ? "Thinking..." : "Ask"}</button>
                  </div>

                  {asking && (
                    <div style={{ padding: 20, textAlign: "center" }}>
                      <span style={{ fontSize: 13, fontFamily: FONT_MONO, color: palette.accent, animation: "pulse 1.5s infinite" }}>
                        Searching belief ledger and synthesizing answer...
                      </span>
                    </div>
                  )}

                  {answer && !asking && (
                    <div style={{ animation: "fadeIn 0.3s ease" }}>
                      <div style={{ padding: "16px 18px", background: palette.bg, borderRadius: 6, border: `1px solid ${palette.border}`, marginBottom: 16 }}>
                        <div style={{ fontSize: 14, color: palette.textBright, lineHeight: 1.6, marginBottom: 12 }}>{answer.answer}</div>
                        <div style={{ display: "flex", gap: 16 }}>
                          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                            <span style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim }}>Confidence:</span>
                            <ConfidenceBar value={answer.confidence} />
                          </div>
                        </div>
                        {answer.reasoning && (
                          <div style={{ marginTop: 12, padding: "10px 14px", background: palette.surface, borderRadius: 4, fontSize: 12, fontFamily: FONT_MONO, color: palette.textDim, lineHeight: 1.5 }}>
                            {answer.reasoning}
                          </div>
                        )}
                      </div>

                      {answer.supporting_claims && answer.supporting_claims.length > 0 && (
                        <div>
                          <div style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, marginBottom: 8, textTransform: "uppercase" }}>
                            Supporting Claims ({answer.supporting_claims.length})
                          </div>
                          {answer.supporting_claims.map(c => (
                            <div key={c.claim_id} style={{
                              padding: "8px 14px", borderLeft: `3px solid ${palette.blue}`, marginBottom: 6,
                              background: palette.bg, borderRadius: "0 4px 4px 0",
                            }}>
                              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                <Badge color={palette.blue}>{c.subject_entity_id}</Badge>
                                <span style={{ fontSize: 12, fontFamily: FONT_MONO, color: palette.textDim }}>{c.predicate}</span>
                                <span style={{ fontSize: 12, color: palette.text }}>{c.object_value}</span>
                                <span style={{ marginLeft: "auto", fontSize: 11, fontFamily: FONT_MONO, color: c.confidence > 0.8 ? palette.green : palette.accent }}>{(c.confidence * 100).toFixed(0)}%</span>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>

                <div style={{ marginTop: 24, maxWidth: 720 }}>
                  <div style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, marginBottom: 10 }}>EXAMPLE QUESTIONS</div>
                  {[
                    "What do we know about SpaceX?",
                    "Has water vapor been detected on any exoplanets?",
                    "What claims have high confidence?",
                    "Are there any contradictions in our beliefs?",
                  ].map((ex, i) => (
                    <button key={i} onClick={() => { setQuestion(ex); setAnswer(null); }} style={{
                      display: "block", width: "100%", textAlign: "left", padding: "10px 14px",
                      background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 6,
                      color: palette.text, fontSize: 12, fontFamily: FONT_MONO, cursor: "pointer", marginBottom: 6,
                    }}>{ex}</button>
                  ))}
                </div>
              </div>
            )}

            {/* SUBMIT */}
            {activeTab === "submit" && (
              <div>
                <h1 style={{ fontSize: 22, fontWeight: 700, color: palette.textBright, marginBottom: 4 }}>Submit Observation</h1>
                <p style={{ fontSize: 13, color: palette.textDim, marginBottom: 28, fontFamily: FONT_MONO }}>Feed observations into the engine for claim extraction</p>
                <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: 24, maxWidth: 640 }}>
                  <label style={{ fontSize: 12, fontWeight: 600, color: palette.textBright, display: "block", marginBottom: 8 }}>Observation Text</label>
                  <textarea
                    value={observationText}
                    onChange={e => setObservationText(e.target.value)}
                    placeholder="e.g. SpaceX launched Starship on March 3rd and achieved full orbit"
                    rows={4}
                    style={{
                      width: "100%", padding: "12px 14px", borderRadius: 6, resize: "vertical",
                      background: palette.bg, border: `1px solid ${palette.border}`, color: palette.text,
                      fontFamily: FONT_MONO, fontSize: 13, outline: "none", boxSizing: "border-box", lineHeight: 1.5,
                    }}
                  />
                  <div style={{ display: "flex", alignItems: "center", gap: 12, marginTop: 16 }}>
                    <button onClick={handleSubmit} disabled={!observationText.trim() || submitting} style={{
                      padding: "10px 24px", borderRadius: 6, border: "none",
                      cursor: observationText.trim() && !submitting ? "pointer" : "not-allowed",
                      fontFamily: FONT_MONO, fontSize: 12, fontWeight: 600,
                      background: palette.accent, color: palette.bg,
                      opacity: !observationText.trim() || submitting ? 0.5 : 1,
                    }}>{submitting ? "Processing..." : "Submit"}</button>
                    {submitting && <span style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.accent }}>extracting claims...</span>}
                  </div>
                  <div style={{ marginTop: 24, padding: "14px 16px", borderRadius: 6, background: palette.bg, border: `1px solid ${palette.border}` }}>
                    <div style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, marginBottom: 8 }}>PIPELINE</div>
                    <div style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, flexWrap: "wrap" }}>
                      <Badge color={palette.blue}>observation</Badge><span>&rarr;</span>
                      <Badge color={palette.purple}>researcher</Badge><span>&rarr;</span>
                      <Badge color={palette.accent}>validator</Badge><span>&rarr;</span>
                      <Badge color={palette.green}>committed</Badge>
                    </div>
                  </div>
                </div>
                <div style={{ marginTop: 24, maxWidth: 640 }}>
                  <div style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, marginBottom: 10 }}>EXAMPLES</div>
                  {[
                    "Water vapor was found in the atmosphere of exoplanet K2-18b by JWST",
                    "SpaceX launched Starship and achieved full orbital insertion",
                    "DeepMind announced AlphaFold 4 with protein interaction predictions",
                    "CERN reported anomalous readings at the LHC suggesting new physics",
                  ].map((ex, i) => (
                    <button key={i} onClick={() => setObservationText(ex)} style={{
                      display: "block", width: "100%", textAlign: "left", padding: "10px 14px",
                      background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 6,
                      color: palette.text, fontSize: 12, fontFamily: FONT_MONO, cursor: "pointer", marginBottom: 6,
                    }}>{ex}</button>
                  ))}
                </div>
              </div>
            )}

            {/* CLAIMS */}
            {activeTab === "claims" && (
              <div>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 20 }}>
                  <div>
                    <h1 style={{ fontSize: 22, fontWeight: 700, color: palette.textBright, marginBottom: 4 }}>Belief Ledger</h1>
                    <p style={{ fontSize: 13, color: palette.textDim, fontFamily: FONT_MONO }}>{claims.length} claims</p>
                  </div>
                  <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 14px", background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 6 }}>
                    <Icon d={Icons.search} size={14} color={palette.textDim} />
                    <input value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="Search claims..." style={{
                      background: "none", border: "none", outline: "none", color: palette.text, fontFamily: FONT_MONO, fontSize: 12, width: 180,
                    }} />
                  </div>
                </div>
                {filteredClaims.length === 0 ? (
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8 }}>
                    <EmptyState icon={Icons.claims} message={searchQuery ? "No matching claims." : "No claims yet."} />
                  </div>
                ) : (
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, overflow: "hidden" }}>
                    <div style={{
                      display: "grid", gridTemplateColumns: "120px 1fr 90px 70px 140px 40px",
                      padding: "10px 18px", borderBottom: `1px solid ${palette.border}`,
                      fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim, textTransform: "uppercase", letterSpacing: "0.06em",
                    }}>
                      <span>Claim ID</span><span>Subject / Predicate / Object</span><span>Service</span><span>Conf.</span><span>Created</span><span></span>
                    </div>
                    <div style={{ maxHeight: 500, overflow: "auto" }}>
                      {filteredClaims.map(c => (
                        <div key={c.claim_id} style={{
                          display: "grid", gridTemplateColumns: "120px 1fr 90px 70px 140px 40px",
                          padding: "10px 18px", borderBottom: `1px solid ${palette.border}`, alignItems: "center", fontSize: 12,
                        }}>
                          <span style={{ fontFamily: FONT_MONO, fontSize: 11, color: palette.textDim }}>{(c.claim_id || "").slice(0, 12)}</span>
                          <div style={{ display: "flex", alignItems: "center", gap: 6, overflow: "hidden" }}>
                            <Badge color={palette.blue}>{c.subject_entity_id}</Badge>
                            <span style={{ color: palette.textDim, fontFamily: FONT_MONO, fontSize: 11 }}>{c.predicate}</span>
                            <span style={{ color: palette.text, fontSize: 12, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{c.object_value}</span>
                          </div>
                          <span style={{ fontFamily: FONT_MONO, fontSize: 11, color: palette.textDim }}>{(c.source_service_id || "").replace("_", " ")}</span>
                          <ConfidenceBar value={c.confidence} />
                          <span style={{ fontFamily: FONT_MONO, fontSize: 10, color: palette.textDim }}>{new Date(c.created_at).toLocaleString()}</span>
                          <button onClick={() => handleRetract(c.claim_id)} title="Retract claim" style={{
                            background: "none", border: "none", cursor: "pointer", padding: 4, borderRadius: 4, display: "flex", alignItems: "center",
                          }}>
                            <Icon d={Icons.trash} size={14} color={palette.red} />
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ENTITIES */}
            {activeTab === "entities" && (
              <div>
                <h1 style={{ fontSize: 22, fontWeight: 700, color: palette.textBright, marginBottom: 4 }}>Entity Explorer</h1>
                <p style={{ fontSize: 13, color: palette.textDim, marginBottom: 24, fontFamily: FONT_MONO }}>{entities.length} entities</p>
                {entities.length === 0 ? (
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8 }}>
                    <EmptyState icon={Icons.entities} message="No entities yet. Submit observations to populate." />
                  </div>
                ) : (
                  <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(280px, 1fr))", gap: 12 }}>
                    {entities.map(e => (
                      <div key={e.canonical_name} style={{
                        background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: "16px 20px",
                      }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}>
                          <Badge color={palette.green}>{e.canonical_name}</Badge>
                          <span style={{ marginLeft: "auto", fontSize: 20, fontWeight: 700, fontFamily: FONT_MONO, color: palette.blue }}>{e.claim_count || 0}</span>
                        </div>
                        <div style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim }}>
                          {e.claim_count || 0} claims
                        </div>
                        {e.aliases && e.aliases.length > 0 && (
                          <div style={{ marginTop: 8, display: "flex", gap: 4, flexWrap: "wrap" }}>
                            {e.aliases.map(a => (
                              <span key={a} style={{
                                fontSize: 10, fontFamily: FONT_MONO, padding: "2px 6px", borderRadius: 3,
                                background: palette.border, color: palette.textDim,
                              }}>{a}</span>
                            ))}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* HIL QUEUE */}
            {activeTab === "hil" && (
              <div>
                <h1 style={{ fontSize: 22, fontWeight: 700, color: palette.textBright, marginBottom: 4 }}>Human-in-the-Loop Queue</h1>
                <p style={{ fontSize: 13, color: palette.textDim, marginBottom: 24, fontFamily: FONT_MONO }}>{hilQueue.length} items</p>
                {hilQueue.length === 0 ? (
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8 }}>
                    <EmptyState icon={Icons.hil} message="No HIL requests." />
                  </div>
                ) : (
                  <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                    {hilQueue.map(h => (
                      <div key={h.envelope_id} style={{
                        background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: "16px 20px",
                      }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}>
                          <Badge color={palette.accent}>PENDING</Badge>
                          <span style={{ fontSize: 12, fontFamily: FONT_MONO, color: palette.textDim }}>{h.reason}</span>
                          <span style={{ marginLeft: "auto", fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim }}>
                            expires {h.expires_at ? new Date(h.expires_at).toLocaleTimeString() : "N/A"}
                          </span>
                        </div>
                        <div style={{ fontSize: 13, color: palette.text, marginBottom: 12, fontFamily: FONT_MONO }}>{h.proposal_summary || JSON.stringify(h.full_payload || {}).slice(0, 120)}</div>
                        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                          <span style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim }}>id: {(h.envelope_id || "").slice(0, 12)}</span>
                          <div style={{ marginLeft: "auto", display: "flex", gap: 8 }}>
                            <button onClick={() => handleHilDecision(h.envelope_id, "approve")} style={{
                              padding: "6px 16px", borderRadius: 5, border: "none", cursor: "pointer",
                              background: palette.greenDim, color: palette.green, fontFamily: FONT_MONO, fontSize: 11, fontWeight: 600,
                            }}>Approve</button>
                            <button onClick={() => handleHilDecision(h.envelope_id, "reject")} style={{
                              padding: "6px 16px", borderRadius: 5, border: "none", cursor: "pointer",
                              background: palette.redDim, color: palette.red, fontFamily: FONT_MONO, fontSize: 11, fontWeight: 600,
                            }}>Reject</button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* CHAT */}
            {activeTab === "chat" && (
              <div style={{ display: "flex", flexDirection: "column", height: "calc(100vh - 48px)" }}>
                <div style={{ marginBottom: 16, flexShrink: 0 }}>
                  <h1 style={{ fontSize: 22, fontWeight: 700, color: palette.textBright, marginBottom: 4 }}>Chat</h1>
                  <p style={{ fontSize: 13, color: palette.textDim, fontFamily: FONT_MONO }}>
                    Talk to the Question Engine — ask questions, submit observations, or run commands
                  </p>
                </div>
                <div style={{ flex: 1, overflow: "auto", padding: "16px 0", display: "flex", flexDirection: "column" }}>
                  {chatMessages.length === 0 && (
                    <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", flex: 1, gap: 16, opacity: 0.6 }}>
                      <Icon d={Icons.chat} size={48} color={palette.textDim} />
                      <span style={{ fontSize: 14, color: palette.textDim, fontFamily: FONT_MONO }}>Start a conversation</span>
                      <div style={{ display: "flex", flexDirection: "column", gap: 8, marginTop: 12, width: "100%", maxWidth: 480 }}>
                        <div style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim, textTransform: "uppercase", marginBottom: 4 }}>Try saying:</div>
                        {[
                          "What do we know about exoplanets?",
                          "NASA announced water on Europa's surface",
                          "Show all claims",
                          "Help",
                        ].map((suggestion, i) => (
                          <button key={i} onClick={() => setChatInput(suggestion)} style={{
                            display: "block", width: "100%", textAlign: "left", padding: "10px 14px",
                            background: palette.surface, border: `1px solid ${palette.border}`,
                            borderRadius: 6, color: palette.text, fontSize: 12, fontFamily: FONT_MONO, cursor: "pointer",
                          }}>{suggestion}</button>
                        ))}
                      </div>
                    </div>
                  )}
                  {chatMessages.map((msg, i) => (
                    <ChatMessage key={msg.id} msg={msg} pipelineEvents={chatPipelineEvents}
                      isLastMessage={i === chatMessages.length - 1}
                      onSuggestionClick={setChatInput} />
                  ))}
                  {chatTyping && (
                    <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 16px", marginBottom: 12 }}>
                      <div style={{ padding: "8px 16px", borderRadius: 12, background: palette.surface, border: `1px solid ${palette.border}` }}>
                        <span style={{ fontSize: 12, fontFamily: FONT_MONO, color: palette.accent, animation: "pulse 1.5s infinite" }}>Thinking...</span>
                      </div>
                    </div>
                  )}
                  <div ref={chatEndRef} />
                </div>
                <div style={{ flexShrink: 0, padding: "16px 0 0", borderTop: `1px solid ${palette.border}` }}>
                  <div style={{ display: "flex", gap: 10, alignItems: "flex-end", background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 10, padding: "10px 14px" }}>
                    <textarea
                      value={chatInput}
                      onChange={e => setChatInput(e.target.value)}
                      onKeyDown={e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleChatSend(); } }}
                      placeholder="Ask a question, share an observation, or type a command..."
                      rows={1}
                      style={{
                        flex: 1, resize: "none", border: "none", outline: "none",
                        background: "transparent", color: palette.text,
                        fontFamily: FONT_MONO, fontSize: 13, lineHeight: 1.5, maxHeight: 120, overflow: "auto",
                      }}
                    />
                    <button
                      onClick={handleChatSend}
                      disabled={!chatInput.trim() || chatTyping}
                      style={{
                        padding: "8px 20px", borderRadius: 6, border: "none",
                        cursor: chatInput.trim() && !chatTyping ? "pointer" : "not-allowed",
                        fontFamily: FONT_MONO, fontSize: 12, fontWeight: 600,
                        background: palette.accent, color: palette.bg,
                        opacity: !chatInput.trim() || chatTyping ? 0.5 : 1, flexShrink: 0,
                      }}
                    >Send</button>
                  </div>
                </div>
              </div>
            )}

            {/* EVENT BUS */}
            {activeTab === "bus" && (() => {
              const visibleEvents = displayPrefs.eventFilters && displayPrefs.eventFilters.length > 0
                ? events.filter(e => displayPrefs.eventFilters.includes((e.topic || "").split(".")[0]))
                : events;
              const isFiltered = displayPrefs.eventFilters && displayPrefs.eventFilters.length < 20;
              return (
              <div>
                <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 4 }}>
                  <h1 style={{ fontSize: 22, fontWeight: 700, color: palette.textBright }}>Event Bus</h1>
                  {isFiltered && <Badge color={palette.accent}>filtered</Badge>}
                </div>
                <p style={{ fontSize: 13, color: palette.textDim, marginBottom: 24, fontFamily: FONT_MONO }}>Real-time message flow - {visibleEvents.length} events{isFiltered ? ` (${events.length} total)` : ""}</p>
                {visibleEvents.length === 0 ? (
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8 }}>
                    <EmptyState icon={Icons.bus} message="No events yet." />
                  </div>
                ) : (
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, overflow: "hidden", fontFamily: FONT_MONO, fontSize: 12 }}>
                    <div style={{
                      display: "grid", gridTemplateColumns: "100px 180px 130px 1fr 100px",
                      padding: "10px 18px", borderBottom: `1px solid ${palette.border}`,
                      fontSize: 10, color: palette.textDim, textTransform: "uppercase", letterSpacing: "0.06em",
                    }}>
                      <span>Time</span><span>Topic</span><span>Source</span><span>Payload</span><span>Envelope</span>
                    </div>
                    <div style={{ maxHeight: 520, overflow: "auto" }}>
                      {visibleEvents.map((e, i) => {
                        const isContradiction = e.topic === "claims.contradiction_detected";
                        return (
                          <div key={e.envelope_id + i} style={{
                            display: "grid", gridTemplateColumns: "100px 180px 130px 1fr 100px",
                            padding: "8px 18px", borderBottom: `1px solid ${palette.border}`, alignItems: "center",
                            animation: i === 0 ? "fadeIn 0.3s ease" : undefined,
                            background: isContradiction ? palette.redDim : "transparent",
                          }}>
                            <span style={{ fontSize: 10, color: palette.textDim }}>{new Date(e.timestamp).toLocaleTimeString()}</span>
                            <TopicBadge topic={e.topic} />
                            <span style={{ fontSize: 11, color: palette.textDim }}>{e.source_service_id}</span>
                            <span style={{ fontSize: 11, color: isContradiction ? palette.red : palette.text, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                              {isContradiction && "CONTRADICTION: "}{e.payload}
                            </span>
                            <span style={{ fontSize: 10, color: palette.textDim }}>{(e.envelope_id || "").slice(0, 10)}</span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
              );
            })()}

            {/* SETTINGS */}
            {activeTab === "settings" && (
              <div>
                <h1 style={{ fontSize: 22, fontWeight: 700, color: palette.textBright, marginBottom: 4 }}>Settings</h1>
                <p style={{ fontSize: 13, color: palette.textDim, marginBottom: 24, fontFamily: FONT_MONO }}>Configure engine behavior and display preferences</p>

                {settingsError && (
                  <div style={{ background: palette.redDim, border: `1px solid ${palette.red}40`, borderRadius: 6, padding: "10px 14px", marginBottom: 16, fontSize: 13, color: palette.red, fontFamily: FONT_MONO }}>{settingsError}</div>
                )}
                {settingsSuccess && (
                  <div style={{ background: palette.greenDim, border: `1px solid ${palette.green}40`, borderRadius: 6, padding: "10px 14px", marginBottom: 16, fontSize: 13, color: palette.green, fontFamily: FONT_MONO }}>Settings saved successfully</div>
                )}

                <div style={{ maxWidth: 640, display: "flex", flexDirection: "column", gap: 20 }}>

                  {/* Budget & Spending */}
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: "20px 24px" }}>
                    <div style={{ fontSize: 13, fontWeight: 600, color: palette.textBright, marginBottom: 16 }}>Budget & Spending</div>
                    <div style={{ display: "flex", gap: 20, marginBottom: 16 }}>
                      <div style={{ flex: 1 }}>
                        <label style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, textTransform: "uppercase", letterSpacing: "0.06em", display: "block", marginBottom: 6 }}>Monthly Limit (USD)</label>
                        <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                          <span style={{ fontSize: 14, color: palette.textDim }}>$</span>
                          <input type="number" min="1" step="1" value={settings.budget.monthly_limit_usd} onChange={e => updateSetting("budget", "monthly_limit_usd", parseFloat(e.target.value) || 1)} style={{
                            width: 120, padding: "8px 10px", borderRadius: 5, border: `1px solid ${palette.border}`, background: palette.bg, color: palette.text, fontFamily: FONT_MONO, fontSize: 13, outline: "none",
                          }} />
                        </div>
                      </div>
                      <div style={{ flex: 1 }}>
                        <label style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, textTransform: "uppercase", letterSpacing: "0.06em", display: "block", marginBottom: 6 }}>Alert Threshold</label>
                        <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                          <input type="range" min="50" max="95" value={Math.round(settings.budget.alert_at_pct * 100)} onChange={e => updateSetting("budget", "alert_at_pct", parseInt(e.target.value) / 100)} style={{ flex: 1, accentColor: palette.accent }} />
                          <span style={{ fontSize: 12, fontFamily: FONT_MONO, color: palette.accent, minWidth: 36 }}>{Math.round(settings.budget.alert_at_pct * 100)}%</span>
                        </div>
                      </div>
                    </div>
                    {budget && (
                      <div style={{ padding: "10px 14px", background: palette.bg, borderRadius: 6, border: `1px solid ${palette.border}`, fontSize: 12, fontFamily: FONT_MONO, color: palette.textDim }}>
                        Current spend: <span style={{ color: palette.text }}>${budget.total_spend?.toFixed(4)}</span> / ${budget.limit_usd?.toFixed(2)} ({Math.round((budget.remaining_pct || 0) * 100)}% remaining)
                      </div>
                    )}
                  </div>

                  {/* Pipeline & Runtime */}
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: "20px 24px" }}>
                    <div style={{ fontSize: 13, fontWeight: 600, color: palette.textBright, marginBottom: 16 }}>Pipeline & Runtime</div>
                    <div style={{ display: "flex", gap: 20 }}>
                      <div style={{ flex: 1 }}>
                        <label style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, textTransform: "uppercase", letterSpacing: "0.06em", display: "block", marginBottom: 6 }}>HIL Timeout (seconds)</label>
                        <input type="number" min="60" step="60" value={settings.runtime.hil_timeout_seconds} onChange={e => updateSetting("runtime", "hil_timeout_seconds", parseInt(e.target.value) || 60)} style={{
                          width: 120, padding: "8px 10px", borderRadius: 5, border: `1px solid ${palette.border}`, background: palette.bg, color: palette.text, fontFamily: FONT_MONO, fontSize: 13, outline: "none",
                        }} />
                      </div>
                      <div style={{ flex: 1 }}>
                        <label style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, textTransform: "uppercase", letterSpacing: "0.06em", display: "block", marginBottom: 6 }}>Log Level</label>
                        <select value={settings.runtime.log_level} onChange={e => updateSetting("runtime", "log_level", e.target.value)} style={{
                          width: "100%", padding: "8px 10px", borderRadius: 5, border: `1px solid ${palette.border}`, background: palette.bg, color: palette.text, fontFamily: FONT_MONO, fontSize: 13, outline: "none",
                        }}>
                          {["DEBUG", "INFO", "WARNING", "ERROR"].map(l => <option key={l} value={l}>{l}</option>)}
                        </select>
                      </div>
                    </div>
                  </div>

                  {/* Save Button */}
                  <button onClick={handleSettingsSave} disabled={!settingsDirty || settingsSaving} style={{
                    width: "100%", padding: "12px 20px", borderRadius: 8, border: "none",
                    cursor: settingsDirty && !settingsSaving ? "pointer" : "not-allowed",
                    background: settingsDirty && !settingsSaving ? `linear-gradient(135deg, ${palette.accent}, #c47e2a)` : palette.border,
                    color: settingsDirty && !settingsSaving ? "#fff" : palette.textDim,
                    fontFamily: FONT_MONO, fontSize: 14, fontWeight: 700, transition: "all 0.2s",
                  }}>{settingsSaving ? "Saving..." : settingsDirty ? "Save Settings" : "No Changes"}</button>

                  <div style={{ height: 1, background: palette.border }} />

                  {/* Event Bus Filters (localStorage) */}
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: "20px 24px" }}>
                    <div style={{ fontSize: 13, fontWeight: 600, color: palette.textBright, marginBottom: 4 }}>Event Bus Filters</div>
                    <div style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, marginBottom: 14 }}>Select which topic groups appear in the Event Bus tab</div>
                    <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                      {["observations", "claims", "goals", "tasks", "hil", "system", "chat", "channels", "inference", "entities", "queries", "ingestion"].map(group => {
                        const active = (displayPrefs.eventFilters || []).includes(group);
                        return (
                          <button key={group} onClick={() => toggleEventFilter(group)} style={{
                            padding: "6px 12px", borderRadius: 5, fontSize: 11, fontFamily: FONT_MONO, cursor: "pointer",
                            border: `1px solid ${active ? palette.accent + "60" : palette.border}`,
                            background: active ? palette.accentDim : "transparent",
                            color: active ? palette.accent : palette.textDim, fontWeight: active ? 600 : 400,
                          }}>{group}</button>
                        );
                      })}
                    </div>
                  </div>

                  {/* Claims Display (localStorage) */}
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: "20px 24px" }}>
                    <div style={{ fontSize: 13, fontWeight: 600, color: palette.textBright, marginBottom: 4 }}>Claims Display</div>
                    <div style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, marginBottom: 14 }}>Filter claims shown in the Belief Ledger tab</div>
                    <div style={{ display: "flex", gap: 20, marginBottom: 16 }}>
                      <div style={{ flex: 1 }}>
                        <label style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, textTransform: "uppercase", letterSpacing: "0.06em", display: "block", marginBottom: 6 }}>Min Confidence</label>
                        <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                          <input type="range" min="0" max="100" value={displayPrefs.minConfidence || 0} onChange={e => setDisplayPrefs(prev => ({ ...prev, minConfidence: parseInt(e.target.value) }))} style={{ flex: 1, accentColor: palette.accent }} />
                          <span style={{ fontSize: 12, fontFamily: FONT_MONO, color: palette.accent, minWidth: 36 }}>{displayPrefs.minConfidence || 0}%</span>
                        </div>
                      </div>
                      <div style={{ flex: 1 }}>
                        <label style={{ fontSize: 11, fontFamily: FONT_MONO, color: palette.textDim, textTransform: "uppercase", letterSpacing: "0.06em", display: "block", marginBottom: 6 }}>Time Range</label>
                        <select value={displayPrefs.timeRange || "all"} onChange={e => setDisplayPrefs(prev => ({ ...prev, timeRange: e.target.value }))} style={{
                          width: "100%", padding: "8px 10px", borderRadius: 5, border: `1px solid ${palette.border}`, background: palette.bg, color: palette.text, fontFamily: FONT_MONO, fontSize: 13, outline: "none",
                        }}>
                          <option value="all">All time</option>
                          <option value="1h">Last hour</option>
                          <option value="24h">Last 24 hours</option>
                          <option value="7d">Last 7 days</option>
                        </select>
                      </div>
                    </div>
                    <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                      <div style={{
                        width: 38, height: 22, borderRadius: 11, cursor: "pointer",
                        background: displayPrefs.showSuperseded ? palette.green : palette.border,
                        transition: "background 0.2s", position: "relative",
                      }} onClick={() => { setDisplayPrefs(prev => ({ ...prev, showSuperseded: !prev.showSuperseded })); setTimeout(fetchClaims, 100); }}>
                        <div style={{
                          width: 18, height: 18, borderRadius: "50%", background: "#fff",
                          position: "absolute", top: 2, left: displayPrefs.showSuperseded ? 18 : 2, transition: "left 0.2s",
                        }} />
                      </div>
                      <div>
                        <div style={{ fontSize: 12, color: palette.text }}>Show superseded claims</div>
                        <div style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim }}>Include retracted and overridden claims</div>
                      </div>
                    </div>
                  </div>

                  {/* Service Control */}
                  <div style={{ background: palette.surface, border: `1px solid ${palette.border}`, borderRadius: 8, padding: "20px 24px" }}>
                    <div style={{ fontSize: 13, fontWeight: 600, color: palette.textBright, marginBottom: 14 }}>Service Control</div>
                    {services.length === 0 ? (
                      <span style={{ fontSize: 12, fontFamily: FONT_MONO, color: palette.textDim }}>No services running</span>
                    ) : (
                      <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                        {services.map(s => (
                          <div key={s.service_id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 12px", background: palette.bg, borderRadius: 6, border: `1px solid ${palette.border}` }}>
                            <StatusDot alive={s.status === "alive"} />
                            <span style={{ fontSize: 12, color: palette.text, flex: 1 }}>{s.display_name || s.service_id}</span>
                            <span style={{ fontSize: 10, fontFamily: FONT_MONO, color: palette.textDim }}>t{s.turn_count || 0}</span>
                            {s.circuit_broken && (
                              <React.Fragment>
                                <Badge color={palette.red}>BROKEN</Badge>
                                <button onClick={() => handleResetCircuit(s.service_id)} style={{
                                  padding: "4px 12px", borderRadius: 4, fontSize: 10, fontFamily: FONT_MONO, fontWeight: 600,
                                  border: "none", cursor: "pointer", background: palette.accentDim, color: palette.accent,
                                }}>Reset</button>
                              </React.Fragment>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                </div>
              </div>
            )}
          </main>
        </div>
      );
    }

    function Root() {
      const [setupComplete, setSetupComplete] = useState(null); // null = loading

      useEffect(() => {
        fetch(`${API}/api/setup/status`).then(r => r.json()).then(data => {
          setSetupComplete(data.complete);
        }).catch(() => setSetupComplete(false));
      }, []);

      if (setupComplete === null) {
        return (
          <div style={{
            minHeight: "100vh", background: palette.bg, display: "flex",
            alignItems: "center", justifyContent: "center",
          }}>
            <div style={{ fontFamily: FONT_MONO, color: palette.textDim, fontSize: 14 }}>Loading...</div>
          </div>
        );
      }

      if (!setupComplete) {
        return <SetupScreen onComplete={() => window.location.reload()} />;
      }

      return <App />;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<Root />);
  </script>
</body>
</html>
